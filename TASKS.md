# TASKS.md


- [x] 2026-02-09 - Analyze existing markdown docs and `suwayomi_manga_daemon.sh`, then finalize implementation requirements for the C# port.
- [x] 2026-02-09 - Update documentation to reflect agreed C# port requirements and architecture decisions.
- [x] 2026-02-09 - Bootstrap solution structure for implementation (`net9.0`, warnings-as-errors, core project folders, test projects, shared test utilities). DoD: `dotnet build` and `dotnet test` succeed; warnings are treated as errors; test projects and shared test helpers are wired into the solution.
- [x] 2026-02-09 - Create repository `.editorconfig` for AGENTS formatting standards (Allman braces, naming rules, XMLDOC expectations).
- [x] 2026-02-09 - Define YAML schemas for `settings.yml`, `manga_equivalents.yml`, `scene_tags.yml`, and `source_priority.yml` and document validation rules. DoD: concrete schema types exist in code and docs; invalid/missing fields produce deterministic validation errors.
- [x] 2026-02-09 - Implement config bootstrap and migration: if YAML is missing, import legacy `.txt` files and write canonical YAML files. DoD: first-run migration path is implemented and tested for expected, edge, and malformed input cases.
- [x] 2026-02-09 - Implement settings self-healing so missing settings keys are added with defaults and persisted back to `settings.yml`. DoD: loading older/incomplete `settings.yml` auto-populates new keys and writes updated file without deleting existing valid values.
- [x] 2026-02-09 - Strengthen bootstrap/settings parser unit tests to cover expected, edge, and exception guard paths across new self-healing code.
- [x] 2026-02-09 - Harden configuration unit tests across bootstrap/loading/validation files with expected, edge, and exception coverage per function, plus targeted property-based and mutation-test scaffolding.
- [x] 2026-02-09 - Implement config directory logging subsystem (structured, relevant messages, rolling/retention policy as configured). DoD: logs write under config path, include key operational events, and honor configured retention/rotation behavior.
- [x] 2026-02-09 - Centralize logging level parsing so settings validation and logger creation share one canonical implementation.
- [x] 2026-02-09 - Address PR feedback on log-level parser semantics and token-source drift (non-throwing TryParse + single-source supported token list).
- [x] 2026-02-09 - Harden logging file-path safety by rejecting rooted/traversal `logging.file_name` values in validation and enforcing resolved path containment under `paths.log_root_path`.
- [x] 2026-02-11 - Improve XML documentation comments for public configuration validation APIs touched by recent logging/validation changes.
- [x] 2026-02-11 - Expand XML documentation coverage in `SettingsDocumentValidator` to include all members and helper methods used by settings validation.
- [x] 2026-02-11 - Improve XML documentation coverage across logging, hosting, bootstrap, and settings-document types touched in the active feature branch.
- [x] 2026-02-11 - Improve XML documentation comments for all identifiers in modified configuration bootstrap/document/loading/validation files to provide self-contained usage guidance.
- [x] 2026-02-11 - Harden `logging.file_name` validation to reject cross-platform invalid characters, trailing dot/space, and Windows reserved device names at config-validation time.
- [x] 2026-02-11 - Harden `RollingFileLogger` so `LogLevel.None` is always treated as non-emitting sentinel and cannot be logged as an event level.
- [x] 2026-02-12 - Fix cross-platform logging.file_name validation drift by rejecting reserved Windows device names deterministically on all OSes and updating unit tests.
- [x] 2026-02-09 - Implement scene-tag service with default `scene_tags.yml` generation and data-driven tag matching. DoD: missing file is created with defaults; matching behavior is driven exclusively by YAML entries; no hardcoded tag list remains in runtime logic.
- [x] 2026-02-09 - Implement title normalization engine per docs (ASCII fold, punctuation strip, leading-article strip, trailing-`s` singularization, cached compare keys). DoD: normalization rules match documented order and are covered by unit tests for expected, edge, and failure cases.
- [x] 2026-02-09 - Implement equivalence and source-priority services using YAML-backed data models. DoD: canonical title mapping and source ordering are loaded from YAML and exercised by unit tests for precedence, fallback, and invalid entries.
- [x] 2026-02-12 - Add resolution-service regression tests for null guard clauses and unknown lookup out-parameter contracts across equivalence, source-priority, and override resolvers.
- [x] 2026-02-12 - Decouple title-key normalization from configuration validation by introducing `TitleKeyNormalizer` in domain and wiring resolution plus validation adapter call sites to it.
- [x] 2026-02-12 - Address PR review feedback by removing avoidable title-normalization array allocations, correcting resolver XML-doc performance wording, and freezing resolver lookup dictionaries.
- [x] 2026-02-09 - Implement source/override volume discovery for container layout (treat direct children of `/ssm/sources` and `/ssm/override` as mapped volumes). DoD: discovery returns correct direct-child volumes only, with tests for empty dirs, mixed files, and nested paths.
- [x] 2026-02-12 - Improve semantic-feature unit tests for scene-tag matcher, title normalization, equivalence validation, and bootstrap cross-document validation with expected/edge/exception coverage.
- [x] 2026-02-12 - Support punctuation-only scene tags using exact-sequence matcher semantics and align scene-tag duplicate validation with matcher-equivalent keys.
- [x] 2026-02-12 - Add title-fixture regression tests for scene-tag stripping outcomes and adjust default scene tags (`all chapters` added, `valir scans` removed) to match expected behavior.
- [x] 2026-02-12 - Decouple shared comparison/token normalization from configuration validation by introducing domain-level normalization primitives consumed by scene-tag matching and validators.
- [x] 2026-02-09 - Implement command execution abstraction for external Linux tools (`mergerfs`, `findmnt`, `fusermount*`, `inotifywait`) with timeout and error handling. DoD: command runner supports timeout, cancellation, stderr/stdout capture, and typed failure handling with test coverage.
- [x] 2026-02-12 - Refactor `ExternalCommandExecutor` output capture to task-based readers and fix boundary race classification so process exit wins over timeout/cancellation at handoff boundaries.
- [x] 2026-02-12 - Address PR #7 process-executor review comments by adding final boundary exit rechecks, field-specific validation `ParamName` diagnostics, traced non-fatal capture-completion exception handling, and CTS-disposal plus diagnostic assertions in tests.
- [x] 2026-02-09 - Implement mount-state snapshot and reconciliation service (desired mounts vs actual mounts, remount decisions, stale cleanup). DoD: reconciliation computes mount/unmount/remount actions deterministically and safely handles stale entries in tested scenarios.
- [x] 2026-02-12 - Fix mountpoint reconciliation key drift by normalizing desired/actual/forced/stale mountpoint matching (slash/trailing-separator variants) and add regression tests.
- [x] 2026-02-12 - Fix findmnt `-P` escaped-backslash quote termination parsing drift and add parser/service regression tests.
- [x] 2026-02-12 - Harden mount parser/reconciliation contracts: non-throwing `TryParse` blank handling, unknown-escape preservation, normalized ordering keys, and regression coverage.
- [x] 2026-02-12 - Address PR review feedback by using compatible `findmnt` pair-mode flags (`-n -P`) and applying minor reconciliation style cleanup.
- [x] 2026-02-12 - Audit legacy shell `findmnt -rn -P` usages in `suwayomi_manga_daemon.sh` for util-linux compatibility and decide migration approach.
- [x] 2026-02-13 - Address PR #11 reviewer feedback by adding timed `findmnt` pair-mode wrapper dispatching to external `findmnt` (not shell functions) under `ro_timeout`.
- [x] 2026-02-09 - Implement branch-link preparation and override branch selection logic (preferred write branch + additional RW override branches + RO source branches). DoD: generated branch order and RW/RO flags match requirements and are validated by integration-style tests.
- [x] 2026-02-12 - Expand cross-platform branch-planning coverage and harden path handling (Windows case-variant path dedupe, separator-safe title/link validation).
- [x] 2026-02-13 - Harden branch-planning path safety by escaping reserved canonical dot-segments and enforcing strict child containment for override/link-derived paths.
- [x] 2026-02-13 - Address branch-planning review notes: align path ordering/dedupe semantics, centralize path validation helpers, harden mode-token mapping and sanitize buffer strategy, and expand regression tests.
- [x] 2026-02-13 - Follow up branch-planning review notes by fixing candidate-path `ParamName` attribution and making override-volume case-variant representative selection deterministic across input permutations.
- [x] 2026-02-13 - Tighten branch-link name validation with deterministic cross-platform invalid-character/trailing-dot-space guards, remove unreachable planner guards, and clarify path-safety parameter semantics.
- [x] 2026-02-13 - Harden branch-planning absolute-path validation by requiring fully-qualified paths in `PathSafetyPolicy` and adding Windows root-relative/drive-relative rejection tests.
- [x] 2026-02-13 - Address PR #9 AI review follow-up by unifying fully-qualified path validation across branch-planning models/services, enforcing standalone title-segment safety, and adding deterministic link-name length hash-truncation.
- [x] 2026-02-09 - Implement `ComicInfo.xml` parsing and `details.json` creation/seeding behavior for overrides. DoD: existing `details.json` seeding and ComicInfo fallback generation both work; parsing and output mapping are covered by unit tests.
- [x] 2026-02-13 - Address AI review follow-up for metadata parity by optimizing depth-limited ComicInfo discovery, deduping attempted candidates, handling copy/move destination races deterministically, and clarifying details result artifact-existence semantics.
- [x] 2026-02-13 - Resolve PR #10 metadata reviewer feedback by hardening best-effort IO/race handling, preserving strict Summary `<br>` markup semantics, and tightening metadata nullability test diagnostics.
- [x] 2026-02-09 - Implement chapter rename rules and queue processor matching current shell behavior for v1. DoD: rename decisions and queue timing/quiet behavior match shell baseline for representative test fixtures.
- [x] 2026-02-14 - Resolve rename sanitizer parity ambiguities by restoring shell-style handling for `chN/epN` prefixes and retaining docs-first embedded chapter-token matching (`Team-S3_MangaChapter6` case).
- [x] 2026-02-14 - Fix rename queue read/overwrite race by introducing atomic queue-store transform semantics and adding concurrent enqueue/process regression coverage.
- [x] 2026-02-14 - Harden rename queue transform atomicity so invalid/throwing transformers do not partially mutate queue state; add regression coverage for null-entry and throwing-transform callbacks.
- [x] 2026-02-14 - Complete rename follow-up refactors: centralize sanitizer token sets with embedded `ch./ep.` support, extract queue-pass processing helpers, add concurrent ProcessOnce and rescan duplicate-skip regressions, and document shell traceability.
- [x] 2026-02-14 - Address PR #12 rename review follow-up: make queue ordering explicit (no dictionary-order reliance), propagate non-benign filesystem enumeration faults, add quiet-check early exit, and document intentional transform lock-scope parity behavior.
- [x] 2026-02-14 - Refine rename enumeration/error boundary: keep filesystem adapter lazy, materialize at processor safe wrappers with benign directory-not-found suppression, and micro-optimize quiet-check timestamp branching.
- [x] 2026-02-09 - Implement filesystem event watcher and trigger pipeline (inotify + periodic rescans + deduped scan requests). DoD: watcher reacts to relevant events, periodic fallback works, and duplicate scans are coalesced under load in integration tests.
- [x] 2026-02-14 - Harden watcher trigger pipeline behavior: enforce hard-stop cancellation checkpoints, dispatch coalesced merge requests outside lock with recoverable exception mapping, perform immediate source/manga recursive rename enqueue, parse inotify lines with last-delimiter semantics, and skip missing watch roots with warnings.
- [x] 2026-02-14 - Address PR #13 watcher-coalescer review follow-up by changing merge request force semantics to latest-request-wins and updating coalescer coverage/docs index wording.
- [x] 2026-02-09 - Implement daemon supervisor lifecycle (startup, health, lock/PID handling, graceful stop/cleanup). DoD: start/stop lifecycle is idempotent, lock behavior prevents duplicate supervisors, and cleanup paths are tested for normal and interrupted shutdown.
- [x] 2026-02-14 - Fix daemon supervisor lifecycle liveness/idempotency regressions by making run-loop stop-timeout fail fast (non-hanging) and coalescing concurrent same-instance start calls, with regression tests.
- [x] 2026-02-14 - Harden daemon supervisor early-stop lifecycle race by capturing run-loop state before signal/cancellation registration and adding immediate-callback regression coverage.
- [x] 2026-02-14 - Complete AI review hygiene follow-up: dedupe supervisor test signal-registration helpers, centralize app-layer recording logger test helper, add host runtime failure shutdown event logging/tests, and document supervisor race-sensitive run-state capture ordering.
- [x] 2026-02-14 - Address PR #14 AI reviewer follow-up by mapping daemon startup exceptions in `RunAsync` to deterministic exit codes, removing redundant supervisor startup `Task.Run` layering, tightening `StartAsync` cancellation XML docs, and adding startup failure/cancellation regression coverage.
- [x] 2026-02-14 - Address PR #15 AI reviewer follow-up by centralizing scene-tag matcher test doubles in unit-test test infrastructure and deduplicating touched resolution/validation/normalization test files.
- [x] 2026-02-14 - Stabilize repository EOL policy as a separate follow-up task: define `.gitattributes` line-ending expectations, verify compatibility with formatter/build behavior, and add a CI-safe check to prevent future LF/CRLF drift.
- [x] 2026-02-15 - Wire runtime supervisor composition to real merge/mount orchestration: replace `NoOpMergeScanRequestHandler` in `DefaultRuntimeSupervisorRunner` with a production merge handler that executes mount planning/reconciliation/apply flows while keeping rename processing active, and honor shutdown unmount settings on supervisor stop. DoD: runtime executes both rename and mount workflows, coalesced merge requests produce real mount/unmount actions, and unit/integration tests cover expected, edge, and failure paths.
- [x] 2026-02-14 - Extract cleanup wrapper `ionice`/`nice` priorities into editable `settings.yml` shutdown fields, wire values through mount workflow command execution, and add validator/self-healing/schema + unit-test coverage for expected, edge, and failure paths.
- [x] 2026-02-14 - Align logging severity/event-ID semantics across merge workflow, dispatch handler, and rename queue paths by splitting busy/failure events where needed, introducing merge-pass error event IDs, and updating tests/contracts for immediate event-ID migration.
- [x] 2026-02-09 - Implement end-to-end integration tests (Docker-based, real filesystem scenarios, tool-command mocks/fakes where needed). DoD: CI-runnable integration suite verifies core workflows and failure recovery paths in a Linux container environment.
- [x] 2026-02-09 - Add container/runtime assets (Dockerfile, entrypoint, required package dependencies, volume and permission expectations). DoD: container builds successfully, starts with documented mounts/permissions, and runs the daemon end-to-end in test environment.
- [x] 2026-02-15 - Harden Docker integration infrastructure by adding fixture image cleanup, full output-drain waits, named stop-grace constant, LF-normalized config writes, sync-poll intent docs, and PGID mismatch warning diagnostics.
- [x] 2026-02-15 - Resolve PR #17 reviewer follow-up by bounding Docker command timeout teardown, returning deterministic timed-out results without indefinite waits, and adding entrypoint fallback-name handling/tests for `ssm` user/group collisions.
- [x] 2026-02-14 - Improve Docker polling assertion diagnostics by ensuring file-read exceptions are preserved in timeout failures while retaining deterministic retry semantics, with focused integration-test coverage.
- [x] 2026-02-14 - Reduce integration command-log read flakiness by centralizing shared-read line counting with bounded transient retry semantics in `DockerAssertions`, wiring unmount-count checks to it, and adding expected/edge/failure behavior tests.
- [x] 2026-02-14 - Apply post-review mount workflow hardening: add resolve-only `override-force` targeting, propagate cancellation into worker shutdown lifecycle, split apply-path cleanup wrapper setting from lifecycle cleanup setting, and fallback from wrapper permission-denied errors to plain command execution with tests/docs updates.
- [x] 2026-02-15 - Harden shutdown and branch-link edge behavior by introducing bounded fresh stop tokens for worker shutdown lifecycle cleanup, replacing dangling branch-link entries via delete-any-entry semantics, and fully splitting merge-pass helpers into dedicated partial files.
- [x] 2026-02-15 - Harden merge mount/watch outcome and cleanup behavior: preserve mapped branch directories for still-mounted targets after cleanup unmount attempts, broaden cleanup-wrapper start-failure fallback to plain command execution, propagate directory-enumeration failures as merge-pass failures, and introduce `MergeScanDispatchOutcome.Mixed` with retry/logging/test coverage.
- [x] 2026-02-15 - Unify source exclusion key normalization across merge and rename flows by introducing a shared trim+case-insensitive source-key normalizer, wiring both call sites to it, and adding regression tests for whitespace/case exclusion matching.
- [x] 2026-02-15 - Harden merge cancellation and unmount precedence: rethrow branch-planning cancellation during merge passes, propagate cancellation through override-title discovery, and prevent busy outcomes from masking non-busy unmount failures, with focused regression tests.
- [x] 2026-02-15 - Harden cleanup and dispatch-failure observability: skip stale branch-directory pruning when post-unmount mount snapshots emit fatal/incomplete warning codes, and ensure production dispatch logs `merge.dispatch.failed` when workflow exceptions are mapped to failure outcomes.
- [x] 2026-02-15 - Replace cleanup warning-code gating with explicit mount-snapshot warning severity classification and normalize unexpected production dispatch outcomes to `Failure`, with focused regression coverage for severity-based prune decisions and handler outcome mapping.
- [x] 2026-02-15 - Tighten final dispatch/cleanup hardening: treat `OperationCanceledException` as cancellation only when the caller token is canceled (otherwise map/log as failure), and skip stale branch-directory pruning when degraded-visibility warnings appear in either pre- or post-unmount snapshots.
- [x] 2026-02-15 - Harden merge-pass degraded-visibility safety and worker shutdown signal clarity: suppress stale-unmount apply actions when merge visibility is degraded (while still allowing mount/remount), downgrade cooperative shutdown cancellation lifecycle logging from warning to debug, and align test-command docs by audience.
- [x] 2026-02-15 - Extend merge-pass degraded-visibility safety and grouping coverage: suppress stale-unmount apply when source-volume discovery reports warnings, include override-only titles in desired grouping (including canonical alias resolution), and split oversized changed mount-workflow unit-test fixtures into sub-500-line partial files.
- [x] 2026-02-15 - Add profile-based settings validation for strict runtime vs relaxed tooling parse paths, wire `ConfigurationSchemaService` entrypoints accordingly, and add focused validator/schema regression tests.
- [x] 2026-02-16 - Implement parse/cancellation/severity policy hardening: add explicit `ParseSettingsForRuntime` routing in bootstrap, centralize mount snapshot warning severity resolution by warning code, and unify cooperative-cancellation classification across dispatch/coalescer/worker paths with regression tests.
- [x] 2026-02-16 - Implement supervisor timeout hard-stop + pragmatic cancellation follow-up: invoke explicit process-termination hook on stop timeout, treat tokenless `OperationCanceledException` as cooperative when caller token is canceled, extend dispatch/coalescer cancellation tests accordingly, and split `MergeMountWorkflow` outcome/cancellation tests into a dedicated partial file to keep touched test files under the 500-line guideline.
- [x] 2026-02-16 - Harden lifecycle cleanup stale-prune behavior by inferring branch directories from still-mounted mergerfs source specs when direct mappings are unavailable, skipping prune only for unresolved mappings, and adding merge-workflow regression coverage.
- [x] 2026-02-16 - Fix supervisor stop-timeout boundary race by rechecking worker completion before hard-stop, and add deterministic expected/edge/failure regression tests for timeout classification and graceful stop behavior.
- [x] 2026-02-17 - Normalize naming conventions repo-wide by migrating SCREAMING_SNAKE const fields to PascalCase, migrating private static readonly fields to `_camelCase`, updating `.editorconfig` naming rules, and adding repository guard tests for member-level naming drift.
- [x] 2026-02-17 - Address PR #18 AI review follow-up: dedupe repository-root test locator helper, fix tooling-profile indentation drift, queue initial startup merge requests in watcher pipeline, and skip invalid override titles with warning-level diagnostics while preserving merge-pass resilience.
- [x] 2026-02-17 - Create a GitHub Actions workflow that builds the Docker image and publishes it to GitHub Container Registry (GHCR).
- [x] 2026-02-17 - Expand Docker publish workflow to run on all branch pushes and tag branch builds with clear `branch-<name>` image tags for testing.
- [x] 2026-02-17 - Rename developer-focused `README.md` to `DEVELOPMENT.md` and add a new public-facing `README.md` with Docker (Dockerfile + CI example) and bare-metal usage instructions.
- [x] 2026-02-17 - Replace public README Dockerfile usage section with Docker Compose deployment instructions and example `compose.yaml`.
- [x] 2026-02-17 - Add README guidance for Unraid Docker volume layout, including explicit underlying disk/pool bind paths and a warning/rationale to avoid `/mnt/user` for runtime merge paths.
- [x] 2026-02-17 - Clarify README Docker requirements so the merged bind mount uses `rshared` for both `docker run` and Docker Compose examples.
- [x] 2026-02-17 - Create an Unraid Community Apps Docker template XML with required FUSE/security flags, rshared merged bind mode, and baseline source/override path mappings.
- [x] 2026-02-17 - Expand the Unraid Community Apps template to include optional source and override disk mappings through `/ssm/sources/disk10` and `/ssm/override/disk10`.
- [x] 2026-02-17 - Silence benign Unraid startup identity warnings by gating PGID mismatch diagnostics to true `ssm` group-ID conflicts and overriding `useradd` UID policy keys for out-of-range requested UIDs, with integration regression coverage.
- [x] 2026-02-17 - Reclassify benign executor-level inotify poll timeouts (without stderr) as non-fatal timed-out outcomes, expand inotify executor timeout headroom, and add watcher-reader regression tests for timeout edge/failure paths.
- [x] 2026-02-17 - Add configurable `scan.merge_trigger_request_timeout_buffer_seconds` with default `300`, wire it through watcher options into `InotifywaitEventReader`, and update schema/self-healing/validation/docs/tests.
- [x] 2026-02-17 - Add unit-test coverage verifying `InotifywaitEventReader` applies the default `requestTimeoutBufferSeconds` value (`300`) when constructor argument is omitted.
- [x] 2026-02-17 - Seed generated default `manga_equivalents.yml` and `source_priority.yml` with one starter example entry each (while retaining existing populated `scene_tags.yml` defaults) and update bootstrap/docs/tests accordingly.
- [x] 2026-02-17 - Fix merge canonical fallback naming so trailing scene-tag suffixes are stripped from source-derived display titles before override branch paths are created, with regression tests for stripped and all-tag edge cases.
- [x] 2026-02-17 - Fix mergerfs mount apply behavior to auto-create missing per-title mountpoint directories before mount/remount execution, and add expected/edge/failure regression tests for directory creation outcomes.
- [x] 2026-02-17 - Fix non-root mergerfs `allow_other` mount failures by ensuring container startup writes `user_allow_other` into `/etc/fuse.conf` before dropping to `PUID`/`PGID`, with integration coverage.
- [x] 2026-02-17 - Prevent container startup hard-failure on stale `/ssm/merged` FUSE endpoints by avoiding recursive chown on merged children and adding integration coverage for the transport-endpoint edge case.
- [x] 2026-02-17 - Gate fuse.conf edits by privilege policy: skip `user_allow_other` write attempts when `PUID=0`, and fail non-root startup with explicit manual-edit and root-runtime remediation guidance when fuse.conf cannot be updated.
- [x] 2026-02-17 - Apply review follow-ups for fuse/mount diagnostics: simplify manual fix example to `sh -c`, include fuse write root-cause details, clarify retry-directory-creation failure messaging, and invert bad-mountpoint retry branch to positive-condition flow.
- [x] 2026-02-17 - Mirror entrypoint diagnostics into the runtime log file path (`paths.log_root_path` + `logging.file_name` with defaults), and add integration coverage proving entrypoint warnings land in `daemon.log`.
- [x] 2026-02-17 - Apply follow-up readability cleanup: standardize `entrypoint.sh` tests to bash-style `[[ ... ]]`, simplify inline fuse write stderr capture substitutions, and clarify retry diagnostic wording to explicitly reference mountpoint directory creation.
- [x] 2026-02-17 - Harden entrypoint log-path mirroring parity: parse section headers/scalars with inline-comment-safe handling, reject unsafe `logging.file_name` values with fallback-to-default warning semantics, and add integration coverage for comment and unsafe-path edge cases.
- [x] 2026-02-17 - Close remaining entrypoint log-path parity gap by matching runtime `logging.file_name` safety rules (reserved device names, trailing dot/space, invalid/control chars) and extend integration coverage for those fallback-warning cases.
- [x] 2026-02-17 - Address follow-up review hygiene: move fuse write-failure reporter to top-level entrypoint helper scope, harden quoted-scalar inline-comment escape handling for escaped-backslash parity, and reword bad-mountpoint retry precheck diagnostic to explicitly state retry mountpoint directory creation failure.
- [x] 2026-02-17 - Fix entrypoint YAML scalar hash-comment parsing drift so embedded `#` in plain `logging.file_name` values (for example `foo#bar.log`) are preserved, with integration coverage for plain and quoted scalar variants.
- [x] 2026-02-17 - Apply review follow-ups for readability and test robustness: add targeted inline comments for entrypoint YAML scalar parsing state transitions, replace stale-merged `chown` mock matching with argv-aware parsing, and reformat bad-mountpoint retry precheck diagnostics into two labeled sentences.
- [x] 2026-02-17 - Mitigate startup mount latency by dispatching startup merges before first inotify poll, introducing persistent inotify monitor sessions (`-m`) for runtime polling, and adding progressive watcher startup mode (`scan.watch_startup_mode`) with configuration/defaults/tests/docs updates.
- [x] 2026-02-17 - Harden non-root startup mount readiness by adding best-effort first-level `/ssm/merged` ownership repair (non-recursive, stale-endpoint-safe warnings) so root-owned legacy title mountpoints do not block `99:100` mergerfs mounts.
- [x] 2026-02-17 - Add non-root FUSE-device access preflight in entrypoint (runtime-identity read/write check, fail-fast diagnostics when inaccessible, warning-only when device is absent/mock mode) with integration regression coverage.
- [x] 2026-02-17 - Fix persistent watcher deep-session reliability by requeueing progressive deep roots after deferred/failed starts, reconciling deep-session health each poll, using refreshed post-wait restart-gate timestamps, deprecating runtime use of `scan.merge_trigger_request_timeout_buffer_seconds` with startup warning diagnostics, and extending unit/integration coverage.
- [x] 2026-02-17 - Apply AI review clarity hardening across watcher/entrypoint paths: document gosu identity intent, extract merged-root path constant in entrypoint, preserve dual gosu access checks with rationale comment, replace persistent-session dispose wait magic number with named timeout constant, and rename startup merge flag to explicit evaluation semantics with test wording updates.
- [x] 2026-02-17 - Address PR #21 AI review follow-ups: refine persistent watcher start-failure classification, prune stale desired-session state when watch roots disappear, bound poll wait-sleep to remaining timeout, align watch-root sort comparer semantics, and harden entrypoint ownership chown flows against symlinked paths with regression coverage.
- [x] 2026-02-17 - Address secondary PR #21 AI review follow-ups: clarify progressive deep-session startup budget semantics (per start phase), fail fast when `FUSE_DEVICE_PATH` is not a character device, and constrain entrypoint privileged log-file ownership adjustments to trusted `/ssm/config`-rooted paths with docs and integration coverage.
- [x] 2026-02-17 - Harden distributed Docker runtime mount permissions by baking `cap_sys_admin` file capabilities onto `mergerfs` and `fusermount3`, documenting Docker remediation steps, and adding integration regression coverage.
- [x] 2026-02-17 - Stabilize startup mounting and eliminate first-tick OOM by adding bounded persistent inotify poll buffers, mount readiness verification with fail-fast consecutive mount failure threshold, and pinned upstream mergerfs runtime packaging with docs/index/test updates.
- [x] 2026-02-17 - Align persistent watcher bounded poll-buffer contracts with append-only semantics by removing unsupported `ICollection<T>` behavior, guaranteeing overflow summary warning retention, and adding focused watcher regression coverage.
- [x] 2026-02-17 - Address code-review hardening follow-ups by enforcing exact Debian mergerfs pin validation in container capability integration tests, strengthening mount-readiness probe materialization semantics, and tightening fail-fast mount-warning diagnostic assertions with index updates.
- [x] 2026-02-18 - Address unresolved PR #23 AI review threads by adding timeout-bounded mount readiness probe execution via mount command service, emitting overflow summary warnings on watcher early returns, and verifying pinned mergerfs package checksums in Docker build.
- [x] 2026-02-18 - Improve unhandled-exception diagnostics by logging full exception stack traces in host/supervisor failure logs and add regression tests.
- [x] 2026-02-18 - Reduce persistent inotify watcher thread pressure by removing per-session `Task.Run` wrappers and using async process-exit observation.
- [x] 2026-02-18 - Fix `findmnt` escaped-value decoding to preserve UTF-8 mountpoint text (prevent mojibake cleanup/unmount mismatches) and add parser regression coverage.
- [x] 2026-02-18 - Prevent mergerfs startup collapse under high mount counts by enforcing a default per-mount thread cap (`threads=1`) when not explicitly configured, and update defaults/docs/tests.
- [x] 2026-02-18 - Harden daemon worker startup under thread-pool pressure by running the filesystem event worker loop on a dedicated long-running task instead of `Task.Run`.
- [x] 2026-02-18 - Improve warning-level merge diagnostics so startup is not silent when no source volumes are discovered or a pass resolves to zero desired mounts.
- [x] 2026-02-18 - Handle container SIGTERM as cooperative supervisor stop so shutdown cleanup runs (unmount sweep + branch-link cleanup), with unit/integration signal-path coverage.
- [x] 2026-02-18 - Introduce `logging.level: normal` (between `debug` and `warning`) as the default and move startup/shutdown and workflow status summaries to this level for non-debug runtime visibility.
- [x] 2026-02-18 - Resolve secondary unresolved PR #23 reviewer follow-ups: correct watcher overflow warning-drop accounting, harden findmnt surrogate decoding, batch mount snapshot readiness validation to one post-apply capture, and remove build-only curl from runtime image with integration assertion coverage.
- [x] 2026-02-18 - Reduce rename queue idle-log noise by suppressing normal-level `rename.queue.processed` summaries for empty queue passes while retaining summaries for non-empty passes, with regression tests.
- [x] 2026-02-19 - Stop regenerating deprecated `scan.merge_trigger_request_timeout_buffer_seconds` during settings self-heal while keeping backward-compatible parsing and runtime warning behavior.
- [x] 2026-02-19 - Stabilize scene-tag stripping and override canonical arbitration by introducing override title catalog-based resolver policy (prefer stripped when available, preserve tagged-only with manual-rename warnings), hardening trailing suffix parsing, adding recommended scene-tag drift warnings, and expanding regression coverage for tagged/stripped duplicate scenarios.
- [x] 2026-02-19 - Apply balanced review-note follow-up: clarify logged POSIX shell-quote helper as display-only (non-executed), document resolver trimmed-title invariant, and expand title/validation normalizer boundary tests for bracket and delimited trailing punctuation/alphanumeric suffix scenarios.
- [x] 2026-02-19 - Fix lifecycle cleanup merged-root handling by removing empty residual mount directories and quarantining non-empty residual directories under config cleanup storage when no managed mounts remain active.
- [x] 2026-02-19 - Close merged cleanup safety gaps by skipping merged-root cleanup when mount snapshot visibility is degraded and enforcing settings validation that rejects overlapping `paths.config_root_path`/`paths.merged_root_path`.
- [x] 2026-02-19 - Apply accurate-only review-note cleanup follow-up by documenting intentional double snapshot enqueue in merged-root cleanup tests and asserting pre/post snapshot capture count.
- [x] 2026-02-20 - Address unresolved PR #27 review thread by hardening config/merged overlap child-path detection for trailing directory separators and adding regression coverage.
- [x] 2026-02-22 - Document planned Comick metadata + FlareSolverr + equivalents-sync feature scope in `DEVELOPMENT.md` and add an implementation-ready task breakdown with DoD.
- [x] 2026-02-22 - Add settings/schema/defaults/self-healing/validation support for `runtime.comick_metadata_cooldown_hours` (default `24`), `runtime.flaresolverr_server_url` (optional, default empty), `runtime.flaresolverr_direct_retry_minutes` (default `60`), and `runtime.preferred_language` (default `en`). DoD: settings models/defaults/validators/schema docs and unit tests are updated with expected/edge/failure coverage.
- [x] 2026-02-22 - Canonicalize `runtime.preferred_language` during settings self-heal by trimming surrounding whitespace, and update bootstrap/schema/index tests/docs for persistence parity.
- [x] 2026-02-22 - Correct `runtime.preferred_language` whitespace policy so self-heal falls back to default `en` when canonicalization yields empty, and update bootstrap/self-heal/docs/index coverage for successful bootstrap behavior.
- [x] 2026-02-22 - Canonicalize `runtime.flaresolverr_server_url` during settings self-heal by trimming surrounding whitespace (including whitespace-only to empty), and update bootstrap/schema/index tests/docs for persistence parity.
- [x] 2026-02-22 - Extend `MergeMountWorkflowOptions` and runtime composition wiring to carry Comick metadata cooldown, FlareSolverr routing, and preferred-language settings into metadata orchestration. DoD: options mapping guards and unit tests validate required/optional behavior.
- [x] 2026-02-22 - Harden `MergeMountWorkflowOptions` FlareSolverr URL guard parity to allow only absolute `http`/`https` URIs when non-empty, and extend mapping tests for unsupported scheme rejection.
- [x] 2026-02-22 - Harden `MetadataOrchestrationOptions` FlareSolverr URI guard parity to allow only absolute `http`/`https` URIs when non-null, and extend constructor tests for relative/unsupported scheme rejection.
- [x] 2026-02-22 - Address PR #29 unresolved AI review threads by clarifying strict-key diagnostics for `runtime.flaresolverr_server_url`, aligning URI parse guard `ParamName` to `settings`, and making metadata propagation test assert explicit reference identity.
- [x] 2026-02-22 - Implement persisted metadata state store under `paths.state_root_path` for per-title cooldown timestamps and sticky FlareSolverr routing expiry state. DoD: state survives process restarts, handles missing/corrupt state files deterministically, and is covered by unit tests.
- [x] 2026-02-22 - Harden metadata state-store startup recovery so directory-path corruption at `metadata_state.json` is quarantined to a deterministic backup directory (with stale-backup replacement and move-failure cleanup fallback), then continue with empty state.
- [x] 2026-02-22 - Clarify `FileBackedMetadataStateStoreTests` constructor-recovery method names so they explicitly describe post-construction state assertions while retaining constructor-triggered semantics.
- [x] 2026-02-22 - Implement direct Comick API client for `/v1.0/search/` and `/comic/{slug}/` with typed response parsing and deterministic transport/parse failure classification. DoD: client unit tests cover success, malformed payload, and request failure paths.
- [x] 2026-02-22 - Harden direct Comick client deterministic classification to cover full request lifecycle (send + response-read + parse) and enforce strict required-list payload-node validation with focused regression tests.
- [x] 2026-02-22 - Split direct Comick client unit tests into behavior-grouped partial files to restore `<500` lines-per-file compliance while preserving coverage semantics.
- [x] 2026-02-22 - Resolve Comick direct-client AI review-note disposition with test-style consistency cleanup (`ArgumentNullException.ThrowIfNull`) while keeping runtime serializer/performance behavior unchanged.
- [x] 2026-02-22 - Resolve unresolved PR AI-review thread on Comick fixture encoding by replacing mojibake `lang_native` test payload with escaped live-equivalent UTF-8 text and asserting parsed `LanguageNative`.
- [x] 2026-02-22 - Implement FlareSolverr client (`POST {runtime.flaresolverr_server_url}/v1`) and response extraction for JSON payload passthrough. DoD: unit tests cover success, invalid wrapper payloads, and timeout/failure handling.
- [x] 2026-02-22 - Implement Cloudflare-aware gateway with direct-first behavior, sticky FlareSolverr fallback on Cloudflare blocks, and timed direct retry probes based on `runtime.flaresolverr_direct_retry_minutes`. DoD: gateway tests cover direct success, fallback activation, sticky expiry retry, and no-Flaresolverr fallback behavior.
- [x] 2026-02-24 - Harden Cloudflare gateway sticky-state concurrency by making sticky persistence monotonic (no expiry regression) and guarding expired-sticky clears inside metadata-state transforms so stale snapshots cannot clear newer sticky state; add focused regression tests for interleaving-style stale-clear and monotonic-update scenarios.
- [x] 2026-02-24 - Harden Cloudflare gateway sticky retry anchoring so sticky expiry uses block-detection timestamp (post-direct probe clock read) instead of request-start timestamp, and clear interleaved sticky entries using post-direct timing semantics with focused regression coverage.
- [x] 2026-02-24 - Apply Copilot review-note cleanup across Comick gateway/parser tests: centralize invariant timestamp parsing (`ParseExact` + `InvariantCulture`) in gateway tests, align helper null guards to `ArgumentNullException.ThrowIfNull`, extract shared base-URI normalization helper in gateway, and document explicit JSON strictness + UTC normalization and stale-read optimization intent.
- [x] 2026-02-24 - Harden override cover ensure semantics by returning deterministic `DownloadFailed` outcomes (instead of throws) for invalid absolute non-HTTP cover keys and by aligning `AlreadyExists` result-path semantics to report the actual existing cover path; add focused regression tests.
- [x] 2026-02-24 - Harden override cover deterministic failure mapping for malformed URI-composition inputs and non-atomic filesystem setup/cleanup errors so these paths return outcome-based failures (no throw leakage), with focused regression coverage.
- [x] 2026-02-24 - Complete override cover write-path deterministic mapping by classifying write-stage `NotSupportedException` and `PathTooLongException` as `WriteFailed` outcomes, with focused service-level regression tests.
- [x] 2026-02-24 - Apply cover-service readability/documentation cleanup from review notes: rename non-JPEG conversion test for fixture accuracy, formalize Comick search alias XML docs, centralize `AlreadyExists` result construction, and simplify nested null-request test setup.
- [x] 2026-02-24 - Apply conversion-catch rationale and cover test-fixture naming clarity cleanup by documenting intentional broad conversion failure mapping and renaming one-pixel GIF/JPEG fixtures consistently across cover-service tests.
- [x] 2026-02-24 - Resolve PR #35 unresolved AI review threads by hardening cover-download determinism (32 MiB cap + bounded streaming) and validating JPEG-signature payload decode integrity before `WrittenDownloadedJpeg`, with focused regression tests and reviewer-thread follow-up.
- [x] 2026-02-22 - Implement strict Comick candidate matching across `comic.title` and `comic.md_titles`, accepting exact-key high-confidence matches with deterministic first-result tie selection. Reuse existing matching fixtures. DoD: matcher tests cover expected unique match, deterministic tie-first behavior, and low-confidence rejection.
- [x] 2026-02-24 - Refactor Comick candidate matcher to resolve `/v1.0/search/` candidates through `/comic/{slug}/` details before matching, keep detail-only match semantics, and rank post-first candidates by normalized Levenshtein similarity using search title/alias hints.
- [x] 2026-02-24 - Apply Comick matcher guard-clarity cleanup by removing unreachable normalized-Levenshtein zero-length branch and documenting intentional defensive null guards in the distance helper.
- [x] 2026-02-24 - Resolve PR #36 unresolved review thread by propagating `ComickDirectApiOutcome.Cancelled` from candidate detail lookups as `OperationCanceledException` (instead of no-match fallback) and adding matcher cancellation regression coverage.
- [x] 2026-02-22 - Implement missing `cover.jpg` generation from Comick cover metadata (`md_covers[0].b2key`) into preferred override directories without overwriting existing files. Handle image conversion to jpg if needed. DoD: expected/exists/race/failure tests verify non-destructive file behavior.
- [ ] 2026-02-22 - Implement API-first `details.json` generation with ComicInfo fallback for missing fields, while appending a language-coded bullet-list block of main and alternate titles to description. DoD: tests verify description-mode compatibility (`text`/`br`/`html`), field precedence, and non-overwrite semantics.
- [ ] 2026-02-22 - Implement safe `manga_equivalents.yml` update service that appends missing aliases to existing groups or creates new groups with canonical selection priority (`preferred_language` -> `en` -> main title). DoD: update path validates documents before write, uses atomic persistence, and includes expected/edge/conflict failure tests.
- [ ] 2026-02-22 - Introduce mutable runtime manga-equivalence catalog behavior so Comick-driven equivalence updates apply immediately in-process after successful persistence. DoD: runtime resolver tests prove immediate effect without restart and deterministic rollback on failed updates.
- [ ] 2026-02-22 - Integrate Comick metadata coordinator into merge-pass title processing while preserving artifact gate behavior (`cover.jpg` and `details.json` checked independently; no API calls when both already exist). DoD: merge workflow tests cover missing-both, missing-cover-only, missing-details-only, and both-exist short-circuit scenarios.
- [ ] 2026-02-22 - Add structured logging/event IDs for cooldown skips, Cloudflare fallback transitions, candidate ambiguity, artifact writes/skips, and equivalents update outcomes. DoD: logging unit tests assert event IDs/levels/context for expected and failure paths.
- [ ] 2026-02-22 - Update `docs/config-schema.md`, `DEVELOPMENT.md`, and `AGENT_INDEX.yml` after implementation to reflect new metadata orchestration, runtime settings, and canonical extension points. DoD: docs/index updates match implemented behavior and validated symbol/path references.
- [ ] 2026-02-22 - Run full quality gate (`dotnet build`, full `dotnet test`) and resolve all warnings/errors for the feature branch. DoD: build and all tests pass with warnings treated as errors.

# TASKS.md


- [x] 2026-02-09 - Analyze existing markdown docs and `suwayomi_manga_daemon.sh`, then finalize implementation requirements for the C# port.
- [x] 2026-02-09 - Update documentation to reflect agreed C# port requirements and architecture decisions.
- [x] 2026-02-09 - Bootstrap solution structure for implementation (`net9.0`, warnings-as-errors, core project folders, test projects, shared test utilities). DoD: `dotnet build` and `dotnet test` succeed; warnings are treated as errors; test projects and shared test helpers are wired into the solution.
- [x] 2026-02-09 - Create repository `.editorconfig` for AGENTS formatting standards (Allman braces, naming rules, XMLDOC expectations).
- [x] 2026-02-09 - Define YAML schemas for `settings.yml`, `manga_equivalents.yml`, `scene_tags.yml`, and `source_priority.yml` and document validation rules. DoD: concrete schema types exist in code and docs; invalid/missing fields produce deterministic validation errors.
- [x] 2026-02-09 - Implement config bootstrap and migration: if YAML is missing, import legacy `.txt` files and write canonical YAML files. DoD: first-run migration path is implemented and tested for expected, edge, and malformed input cases.
- [x] 2026-02-09 - Implement settings self-healing so missing settings keys are added with defaults and persisted back to `settings.yml`. DoD: loading older/incomplete `settings.yml` auto-populates new keys and writes updated file without deleting existing valid values.
- [x] 2026-02-09 - Strengthen bootstrap/settings parser unit tests to cover expected, edge, and exception guard paths across new self-healing code.
- [x] 2026-02-09 - Harden configuration unit tests across bootstrap/loading/validation files with expected, edge, and exception coverage per function, plus targeted property-based and mutation-test scaffolding.
- [x] 2026-02-09 - Implement config directory logging subsystem (structured, relevant messages, rolling/retention policy as configured). DoD: logs write under config path, include key operational events, and honor configured retention/rotation behavior.
- [x] 2026-02-09 - Centralize logging level parsing so settings validation and logger creation share one canonical implementation.
- [x] 2026-02-09 - Address PR feedback on log-level parser semantics and token-source drift (non-throwing TryParse + single-source supported token list).
- [x] 2026-02-09 - Harden logging file-path safety by rejecting rooted/traversal `logging.file_name` values in validation and enforcing resolved path containment under `paths.log_root_path`.
- [x] 2026-02-11 - Improve XML documentation comments for public configuration validation APIs touched by recent logging/validation changes.
- [x] 2026-02-11 - Expand XML documentation coverage in `SettingsDocumentValidator` to include all members and helper methods used by settings validation.
- [x] 2026-02-11 - Improve XML documentation coverage across logging, hosting, bootstrap, and settings-document types touched in the active feature branch.
- [x] 2026-02-11 - Improve XML documentation comments for all identifiers in modified configuration bootstrap/document/loading/validation files to provide self-contained usage guidance.
- [x] 2026-02-11 - Harden `logging.file_name` validation to reject cross-platform invalid characters, trailing dot/space, and Windows reserved device names at config-validation time.
- [x] 2026-02-11 - Harden `RollingFileLogger` so `LogLevel.None` is always treated as non-emitting sentinel and cannot be logged as an event level.
- [x] 2026-02-12 - Fix cross-platform logging.file_name validation drift by rejecting reserved Windows device names deterministically on all OSes and updating unit tests.
- [x] 2026-02-09 - Implement scene-tag service with default `scene_tags.yml` generation and data-driven tag matching. DoD: missing file is created with defaults; matching behavior is driven exclusively by YAML entries; no hardcoded tag list remains in runtime logic.
- [x] 2026-02-09 - Implement title normalization engine per docs (ASCII fold, punctuation strip, leading-article strip, trailing-`s` singularization, cached compare keys). DoD: normalization rules match documented order and are covered by unit tests for expected, edge, and failure cases.
- [x] 2026-02-09 - Implement equivalence and source-priority services using YAML-backed data models. DoD: canonical title mapping and source ordering are loaded from YAML and exercised by unit tests for precedence, fallback, and invalid entries.
- [x] 2026-02-12 - Add resolution-service regression tests for null guard clauses and unknown lookup out-parameter contracts across equivalence, source-priority, and override resolvers.
- [x] 2026-02-12 - Decouple title-key normalization from configuration validation by introducing `TitleKeyNormalizer` in domain and wiring resolution plus validation adapter call sites to it.
- [x] 2026-02-12 - Address PR review feedback by removing avoidable title-normalization array allocations, correcting resolver XML-doc performance wording, and freezing resolver lookup dictionaries.
- [x] 2026-02-09 - Implement source/override volume discovery for container layout (treat direct children of `/ssm/sources` and `/ssm/override` as mapped volumes). DoD: discovery returns correct direct-child volumes only, with tests for empty dirs, mixed files, and nested paths.
- [x] 2026-02-12 - Improve semantic-feature unit tests for scene-tag matcher, title normalization, equivalence validation, and bootstrap cross-document validation with expected/edge/exception coverage.
- [x] 2026-02-12 - Support punctuation-only scene tags using exact-sequence matcher semantics and align scene-tag duplicate validation with matcher-equivalent keys.
- [x] 2026-02-12 - Add title-fixture regression tests for scene-tag stripping outcomes and adjust default scene tags (`all chapters` added, `valir scans` removed) to match expected behavior.
- [x] 2026-02-12 - Decouple shared comparison/token normalization from configuration validation by introducing domain-level normalization primitives consumed by scene-tag matching and validators.
- [x] 2026-02-09 - Implement command execution abstraction for external Linux tools (`mergerfs`, `findmnt`, `fusermount*`, `inotifywait`) with timeout and error handling. DoD: command runner supports timeout, cancellation, stderr/stdout capture, and typed failure handling with test coverage.
- [x] 2026-02-12 - Refactor `ExternalCommandExecutor` output capture to task-based readers and fix boundary race classification so process exit wins over timeout/cancellation at handoff boundaries.
- [x] 2026-02-12 - Address PR #7 process-executor review comments by adding final boundary exit rechecks, field-specific validation `ParamName` diagnostics, traced non-fatal capture-completion exception handling, and CTS-disposal plus diagnostic assertions in tests.
- [x] 2026-02-09 - Implement mount-state snapshot and reconciliation service (desired mounts vs actual mounts, remount decisions, stale cleanup). DoD: reconciliation computes mount/unmount/remount actions deterministically and safely handles stale entries in tested scenarios.
- [x] 2026-02-12 - Fix mountpoint reconciliation key drift by normalizing desired/actual/forced/stale mountpoint matching (slash/trailing-separator variants) and add regression tests.
- [x] 2026-02-12 - Fix findmnt `-P` escaped-backslash quote termination parsing drift and add parser/service regression tests.
- [x] 2026-02-12 - Harden mount parser/reconciliation contracts: non-throwing `TryParse` blank handling, unknown-escape preservation, normalized ordering keys, and regression coverage.
- [x] 2026-02-12 - Address PR review feedback by using compatible `findmnt` pair-mode flags (`-n -P`) and applying minor reconciliation style cleanup.
- [x] 2026-02-12 - Audit legacy shell `findmnt -rn -P` usages in `suwayomi_manga_daemon.sh` for util-linux compatibility and decide migration approach.
- [x] 2026-02-13 - Address PR #11 reviewer feedback by adding timed `findmnt` pair-mode wrapper dispatching to external `findmnt` (not shell functions) under `ro_timeout`.
- [x] 2026-02-09 - Implement branch-link preparation and override branch selection logic (preferred write branch + additional RW override branches + RO source branches). DoD: generated branch order and RW/RO flags match requirements and are validated by integration-style tests.
- [x] 2026-02-12 - Expand cross-platform branch-planning coverage and harden path handling (Windows case-variant path dedupe, separator-safe title/link validation).
- [x] 2026-02-13 - Harden branch-planning path safety by escaping reserved canonical dot-segments and enforcing strict child containment for override/link-derived paths.
- [x] 2026-02-13 - Address branch-planning review notes: align path ordering/dedupe semantics, centralize path validation helpers, harden mode-token mapping and sanitize buffer strategy, and expand regression tests.
- [x] 2026-02-13 - Follow up branch-planning review notes by fixing candidate-path `ParamName` attribution and making override-volume case-variant representative selection deterministic across input permutations.
- [x] 2026-02-13 - Tighten branch-link name validation with deterministic cross-platform invalid-character/trailing-dot-space guards, remove unreachable planner guards, and clarify path-safety parameter semantics.
- [x] 2026-02-13 - Harden branch-planning absolute-path validation by requiring fully-qualified paths in `PathSafetyPolicy` and adding Windows root-relative/drive-relative rejection tests.
- [x] 2026-02-13 - Address PR #9 AI review follow-up by unifying fully-qualified path validation across branch-planning models/services, enforcing standalone title-segment safety, and adding deterministic link-name length hash-truncation.
- [x] 2026-02-09 - Implement `ComicInfo.xml` parsing and `details.json` creation/seeding behavior for overrides. DoD: existing `details.json` seeding and ComicInfo fallback generation both work; parsing and output mapping are covered by unit tests.
- [x] 2026-02-13 - Address AI review follow-up for metadata parity by optimizing depth-limited ComicInfo discovery, deduping attempted candidates, handling copy/move destination races deterministically, and clarifying details result artifact-existence semantics.
- [x] 2026-02-13 - Resolve PR #10 metadata reviewer feedback by hardening best-effort IO/race handling, preserving strict Summary `<br>` markup semantics, and tightening metadata nullability test diagnostics.
- [x] 2026-02-09 - Implement chapter rename rules and queue processor matching current shell behavior for v1. DoD: rename decisions and queue timing/quiet behavior match shell baseline for representative test fixtures.
- [x] 2026-02-14 - Resolve rename sanitizer parity ambiguities by restoring shell-style handling for `chN/epN` prefixes and retaining docs-first embedded chapter-token matching (`Team-S3_MangaChapter6` case).
- [x] 2026-02-14 - Fix rename queue read/overwrite race by introducing atomic queue-store transform semantics and adding concurrent enqueue/process regression coverage.
- [x] 2026-02-14 - Harden rename queue transform atomicity so invalid/throwing transformers do not partially mutate queue state; add regression coverage for null-entry and throwing-transform callbacks.
- [x] 2026-02-14 - Complete rename follow-up refactors: centralize sanitizer token sets with embedded `ch./ep.` support, extract queue-pass processing helpers, add concurrent ProcessOnce and rescan duplicate-skip regressions, and document shell traceability.
- [x] 2026-02-14 - Address PR #12 rename review follow-up: make queue ordering explicit (no dictionary-order reliance), propagate non-benign filesystem enumeration faults, add quiet-check early exit, and document intentional transform lock-scope parity behavior.
- [x] 2026-02-14 - Refine rename enumeration/error boundary: keep filesystem adapter lazy, materialize at processor safe wrappers with benign directory-not-found suppression, and micro-optimize quiet-check timestamp branching.
- [x] 2026-02-09 - Implement filesystem event watcher and trigger pipeline (inotify + periodic rescans + deduped scan requests). DoD: watcher reacts to relevant events, periodic fallback works, and duplicate scans are coalesced under load in integration tests.
- [x] 2026-02-14 - Harden watcher trigger pipeline behavior: enforce hard-stop cancellation checkpoints, dispatch coalesced merge requests outside lock with recoverable exception mapping, perform immediate source/manga recursive rename enqueue, parse inotify lines with last-delimiter semantics, and skip missing watch roots with warnings.
- [x] 2026-02-14 - Address PR #13 watcher-coalescer review follow-up by changing merge request force semantics to latest-request-wins and updating coalescer coverage/docs index wording.
- [x] 2026-02-09 - Implement daemon supervisor lifecycle (startup, health, lock/PID handling, graceful stop/cleanup). DoD: start/stop lifecycle is idempotent, lock behavior prevents duplicate supervisors, and cleanup paths are tested for normal and interrupted shutdown.
- [x] 2026-02-14 - Fix daemon supervisor lifecycle liveness/idempotency regressions by making run-loop stop-timeout fail fast (non-hanging) and coalescing concurrent same-instance start calls, with regression tests.
- [x] 2026-02-14 - Harden daemon supervisor early-stop lifecycle race by capturing run-loop state before signal/cancellation registration and adding immediate-callback regression coverage.
- [x] 2026-02-14 - Complete AI review hygiene follow-up: dedupe supervisor test signal-registration helpers, centralize app-layer recording logger test helper, add host runtime failure shutdown event logging/tests, and document supervisor race-sensitive run-state capture ordering.
- [x] 2026-02-14 - Address PR #14 AI reviewer follow-up by mapping daemon startup exceptions in `RunAsync` to deterministic exit codes, removing redundant supervisor startup `Task.Run` layering, tightening `StartAsync` cancellation XML docs, and adding startup failure/cancellation regression coverage.
- [x] 2026-02-14 - Address PR #15 AI reviewer follow-up by centralizing scene-tag matcher test doubles in unit-test test infrastructure and deduplicating touched resolution/validation/normalization test files.
- [x] 2026-02-14 - Stabilize repository EOL policy as a separate follow-up task: define `.gitattributes` line-ending expectations, verify compatibility with formatter/build behavior, and add a CI-safe check to prevent future LF/CRLF drift.
- [x] 2026-02-15 - Wire runtime supervisor composition to real merge/mount orchestration: replace `NoOpMergeScanRequestHandler` in `DefaultRuntimeSupervisorRunner` with a production merge handler that executes mount planning/reconciliation/apply flows while keeping rename processing active, and honor shutdown unmount settings on supervisor stop. DoD: runtime executes both rename and mount workflows, coalesced merge requests produce real mount/unmount actions, and unit/integration tests cover expected, edge, and failure paths.
- [x] 2026-02-14 - Extract cleanup wrapper `ionice`/`nice` priorities into editable `settings.yml` shutdown fields, wire values through mount workflow command execution, and add validator/self-healing/schema + unit-test coverage for expected, edge, and failure paths.
- [x] 2026-02-14 - Align logging severity/event-ID semantics across merge workflow, dispatch handler, and rename queue paths by splitting busy/failure events where needed, introducing merge-pass error event IDs, and updating tests/contracts for immediate event-ID migration.
- [x] 2026-02-09 - Implement end-to-end integration tests (Docker-based, real filesystem scenarios, tool-command mocks/fakes where needed). DoD: CI-runnable integration suite verifies core workflows and failure recovery paths in a Linux container environment.
- [x] 2026-02-09 - Add container/runtime assets (Dockerfile, entrypoint, required package dependencies, volume and permission expectations). DoD: container builds successfully, starts with documented mounts/permissions, and runs the daemon end-to-end in test environment.
- [x] 2026-02-15 - Harden Docker integration infrastructure by adding fixture image cleanup, full output-drain waits, named stop-grace constant, LF-normalized config writes, sync-poll intent docs, and PGID mismatch warning diagnostics.
- [x] 2026-02-15 - Resolve PR #17 reviewer follow-up by bounding Docker command timeout teardown, returning deterministic timed-out results without indefinite waits, and adding entrypoint fallback-name handling/tests for `ssm` user/group collisions.
- [x] 2026-02-14 - Improve Docker polling assertion diagnostics by ensuring file-read exceptions are preserved in timeout failures while retaining deterministic retry semantics, with focused integration-test coverage.
- [x] 2026-02-14 - Reduce integration command-log read flakiness by centralizing shared-read line counting with bounded transient retry semantics in `DockerAssertions`, wiring unmount-count checks to it, and adding expected/edge/failure behavior tests.
- [x] 2026-02-14 - Apply post-review mount workflow hardening: add resolve-only `override-force` targeting, propagate cancellation into worker shutdown lifecycle, split apply-path cleanup wrapper setting from lifecycle cleanup setting, and fallback from wrapper permission-denied errors to plain command execution with tests/docs updates.
- [x] 2026-02-15 - Harden shutdown and branch-link edge behavior by introducing bounded fresh stop tokens for worker shutdown lifecycle cleanup, replacing dangling branch-link entries via delete-any-entry semantics, and fully splitting merge-pass helpers into dedicated partial files.
- [x] 2026-02-15 - Harden merge mount/watch outcome and cleanup behavior: preserve mapped branch directories for still-mounted targets after cleanup unmount attempts, broaden cleanup-wrapper start-failure fallback to plain command execution, propagate directory-enumeration failures as merge-pass failures, and introduce `MergeScanDispatchOutcome.Mixed` with retry/logging/test coverage.
- [x] 2026-02-15 - Unify source exclusion key normalization across merge and rename flows by introducing a shared trim+case-insensitive source-key normalizer, wiring both call sites to it, and adding regression tests for whitespace/case exclusion matching.
- [x] 2026-02-15 - Harden merge cancellation and unmount precedence: rethrow branch-planning cancellation during merge passes, propagate cancellation through override-title discovery, and prevent busy outcomes from masking non-busy unmount failures, with focused regression tests.
- [x] 2026-02-15 - Harden cleanup and dispatch-failure observability: skip stale branch-directory pruning when post-unmount mount snapshots emit fatal/incomplete warning codes, and ensure production dispatch logs `merge.dispatch.failed` when workflow exceptions are mapped to failure outcomes.
- [x] 2026-02-15 - Replace cleanup warning-code gating with explicit mount-snapshot warning severity classification and normalize unexpected production dispatch outcomes to `Failure`, with focused regression coverage for severity-based prune decisions and handler outcome mapping.
- [x] 2026-02-15 - Tighten final dispatch/cleanup hardening: treat `OperationCanceledException` as cancellation only when the caller token is canceled (otherwise map/log as failure), and skip stale branch-directory pruning when degraded-visibility warnings appear in either pre- or post-unmount snapshots.
- [x] 2026-02-15 - Harden merge-pass degraded-visibility safety and worker shutdown signal clarity: suppress stale-unmount apply actions when merge visibility is degraded (while still allowing mount/remount), downgrade cooperative shutdown cancellation lifecycle logging from warning to debug, and align test-command docs by audience.
- [x] 2026-02-15 - Extend merge-pass degraded-visibility safety and grouping coverage: suppress stale-unmount apply when source-volume discovery reports warnings, include override-only titles in desired grouping (including canonical alias resolution), and split oversized changed mount-workflow unit-test fixtures into sub-500-line partial files.
- [x] 2026-02-15 - Add profile-based settings validation for strict runtime vs relaxed tooling parse paths, wire `ConfigurationSchemaService` entrypoints accordingly, and add focused validator/schema regression tests.
- [x] 2026-02-16 - Implement parse/cancellation/severity policy hardening: add explicit `ParseSettingsForRuntime` routing in bootstrap, centralize mount snapshot warning severity resolution by warning code, and unify cooperative-cancellation classification across dispatch/coalescer/worker paths with regression tests.
- [x] 2026-02-16 - Implement supervisor timeout hard-stop + pragmatic cancellation follow-up: invoke explicit process-termination hook on stop timeout, treat tokenless `OperationCanceledException` as cooperative when caller token is canceled, extend dispatch/coalescer cancellation tests accordingly, and split `MergeMountWorkflow` outcome/cancellation tests into a dedicated partial file to keep touched test files under the 500-line guideline.
- [x] 2026-02-16 - Harden lifecycle cleanup stale-prune behavior by inferring branch directories from still-mounted mergerfs source specs when direct mappings are unavailable, skipping prune only for unresolved mappings, and adding merge-workflow regression coverage.
- [x] 2026-02-16 - Fix supervisor stop-timeout boundary race by rechecking worker completion before hard-stop, and add deterministic expected/edge/failure regression tests for timeout classification and graceful stop behavior.
- [x] 2026-02-17 - Normalize naming conventions repo-wide by migrating SCREAMING_SNAKE const fields to PascalCase, migrating private static readonly fields to `_camelCase`, updating `.editorconfig` naming rules, and adding repository guard tests for member-level naming drift.
- [x] 2026-02-17 - Address PR #18 AI review follow-up: dedupe repository-root test locator helper, fix tooling-profile indentation drift, queue initial startup merge requests in watcher pipeline, and skip invalid override titles with warning-level diagnostics while preserving merge-pass resilience.
- [x] 2026-02-17 - Create a GitHub Actions workflow that builds the Docker image and publishes it to GitHub Container Registry (GHCR).
- [x] 2026-02-17 - Expand Docker publish workflow to run on all branch pushes and tag branch builds with clear `branch-<name>` image tags for testing.
- [x] 2026-02-17 - Rename developer-focused `README.md` to `DEVELOPMENT.md` and add a new public-facing `README.md` with Docker (Dockerfile + CI example) and bare-metal usage instructions.
- [x] 2026-02-17 - Replace public README Dockerfile usage section with Docker Compose deployment instructions and example `compose.yaml`.
- [x] 2026-02-17 - Add README guidance for Unraid Docker volume layout, including explicit underlying disk/pool bind paths and a warning/rationale to avoid `/mnt/user` for runtime merge paths.
- [x] 2026-02-17 - Clarify README Docker requirements so the merged bind mount uses `rshared` for both `docker run` and Docker Compose examples.
- [x] 2026-02-17 - Create an Unraid Community Apps Docker template XML with required FUSE/security flags, rshared merged bind mode, and baseline source/override path mappings.
- [x] 2026-02-17 - Expand the Unraid Community Apps template to include optional source and override disk mappings through `/ssm/sources/disk10` and `/ssm/override/disk10`.
- [x] 2026-02-17 - Silence benign Unraid startup identity warnings by gating PGID mismatch diagnostics to true `ssm` group-ID conflicts and overriding `useradd` UID policy keys for out-of-range requested UIDs, with integration regression coverage.
- [x] 2026-02-17 - Reclassify benign executor-level inotify poll timeouts (without stderr) as non-fatal timed-out outcomes, expand inotify executor timeout headroom, and add watcher-reader regression tests for timeout edge/failure paths.
- [x] 2026-02-17 - Add configurable `scan.merge_trigger_request_timeout_buffer_seconds` with default `300`, wire it through watcher options into `InotifywaitEventReader`, and update schema/self-healing/validation/docs/tests.
- [x] 2026-02-17 - Add unit-test coverage verifying `InotifywaitEventReader` applies the default `requestTimeoutBufferSeconds` value (`300`) when constructor argument is omitted.
- [x] 2026-02-17 - Seed generated default `manga_equivalents.yml` and `source_priority.yml` with one starter example entry each (while retaining existing populated `scene_tags.yml` defaults) and update bootstrap/docs/tests accordingly.
- [x] 2026-02-17 - Fix merge canonical fallback naming so trailing scene-tag suffixes are stripped from source-derived display titles before override branch paths are created, with regression tests for stripped and all-tag edge cases.
- [ ] 2026-02-09 - Finalize docs and developer index after implementation (`README.md`, `AGENTS.md`, `AGENT_INDEX.yml`, migration notes, operation guide). DoD: docs match shipped behavior, migration path is documented, and `AGENT_INDEX.yml` is updated per `AGENT_INDEX_PROMPT.md`.
